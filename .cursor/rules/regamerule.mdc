---
alwaysApply: true
---
# ReGame Engine Critical Workflow Rules

## 1. ALWAYS Update Both Template AND User Projects
When modifying engine or project code, update BOTH:
- `expo-template/` (project template)
- current user project (e.g., `RegameProjects/MyGame23/`)
Sync these folders:
- `expo-template/engine/` ↔ `RegameProjects/<Project>/engine/`
- `expo-template/package.json` ↔ user project package.json
- `expo-template/metro.config.js` ↔ user project metro.config.js
- `expo-template/app.json` ↔ user project app.json

## 2. File Generation Chain
Saving a scene updates:
1. Scene JSON (`scenes/MainScene.json`)
2. Code generator (`src/utils/codeGenerator.js`) produces `scenes/Main.js`
3. `App.js` loads generated code

**Schema changes require updates to:**
- Save/load logic (`src/App.jsx`)
- Code generator (`src/utils/codeGenerator.js`)
- Runtime engine (in both template and user project)

## 3. Kaplay-Style Component System
- Components use classic Kaplay pattern: `this` refers to the GameObject.
- Script methods must be `.call(gameObject)` in codegen.
- Custom scripts are extracted and wrapped as component functions.

## 4. Expo Dev Build Only (NO Expo Go)
- Dev workflow: `npx expo run:android` (not `expo start`)
- Use Metro for hot reload; reload by sending single 'r' to Metro stdin.
- To specify device: use `ANDROID_SERIAL=<id> npx expo run:android`
- List devices: `adb devices -l`
- List emulators: `emulator -list-avds` (`ANDROID_HOME` required)

## 5. Editor UI
- Godot-style: compact UI, 11-13px fonts, tight layout
- Hierarchy: tree view, icons, right-click menus
- Scene viewport: red border is camera area
- Inspector: property grid for selected object
- Console: strip at bottom, max 120px height

## 6. Package Version Management
Always match these versions (Expo SDK 54):
- `@shopify/react-native-skia`: 2.2.12
- `react-native-gesture-handler`: 2.28.0
- `react-native-reanimated`: 4.1.1
- `expo`: ~54.0.0

## 7. Electron + Vite Dev Server
- Main: `electron/main.js`
- Preload: `electron/preload.js`
- React: `src/App.jsx` runs on Vite server (port 5173)
- Use `concurrently --kill-others` to prevent zombie Electron/Vite processes

## 8. Metro Config Rules (NO Expo Router)
- Only use custom `App.js` entrypoint
- Block `app/` dir in metro config
  ```js
  config.resolver = { blockList: [/.*\/app\/.*/] };
  ```
- `unstable_allowRequireContext: false` in transformer config

## 9. Scene Camera/Viewport System
- Viewport in scene JSON: `{ viewport: { preset, width, height } }`
- Editor draws camera outline
- Runtime uses device size with `useWindowDimensions()`
- Common aspect ratios: 9:16, 16:9, 9:19.5, 4:3, 16:10

## 10. Pitfalls to Avoid
- Never use `CI: '1'` (kills Metro)
- Don't kill port 8081 manually
- Don't forget to sync template AND project
- Expo Go is NOT supported
- Don't use `--device=` for expo run:android (use `ANDROID_SERIAL`)

# Checklist for Every Change
- [ ] Update the template
- [ ] Update user/open project
- [ ] Update code generator if schema changes
- [ ] Test on Expo Dev Build
- [ ] Check package versions match SDK 54
